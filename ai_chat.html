<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AI å¿ƒç†ç–å¯¼ - Psychç»Ÿè®¡è‡ªä¹ å®¤</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root{
      --primary-1:#3f6ea8;
      --primary-2:#2b4e78;
      --muted:#7b8a9a;
      --bg:#ffffff;
      --chat-bg:#f7fbff;
      --safe-bottom: env(safe-area-inset-bottom, 12px);
      --controls-height: 68px; /* æ§ä»¶é«˜åº¦ï¼ˆå«å†…è¾¹è·ï¼‰â€”â€”ç”¨äº chat åŒºåº•éƒ¨å†…è¾¹è·è®¡ç®— */
    }

    /* åŸºç¡€é‡ç½® */
    *{box-sizing:border-box;margin:0;padding:0;font-family: "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;}
    html,body,#app{height:100%;}
    body{background:var(--bg); color:#1f2937; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

    /* æ•´é¡µå¸ƒå±€ï¼šä½¿ç”¨è§†å£é«˜åº¦ï¼Œheader + chat-areaï¼Œå‘é€æ§ä»¶å›ºå®šåœ¨åº•éƒ¨ */
    .app{height:100vh; display:flex; flex-direction:column; align-items:center; background:var(--bg);}

    /* é™å®½å±…ä¸­å®¹å™¨ï¼ˆé¡µé¢å†…å®¹å±…ä¸­ä½†é€‚åº”æ‰‹æœºå®½åº¦ï¼‰ */
    .viewport { width:100%; max-width:920px; height:100%; display:flex; flex-direction:column; }

    /* header ç´§å‡‘ */
    header{padding:8px 12px; border-bottom:1px solid rgba(15,23,42,0.03); background:transparent;}
    .logo{display:flex; align-items:center; gap:8px; font-weight:700; color:#123458; font-size:15px;}
    .logo i{color:var(--primary-1); font-size:18px;}

    /* èŠå¤©ä¸»åŒºï¼šå æ»¡ header ä¸åº•éƒ¨æ§ä»¶ä¹‹ï¿½ï¿½å‰©ä½™ç©ºé—´ */
    .chat-wrapper{flex:1; display:flex; flex-direction:column; min-height:0; /* å…³é”®ï¼šä½¿å†…éƒ¨å¯æ»šåŠ¨ */ }

    /* chat-box å ç”¨å¤§éƒ¨åˆ†ç©ºé—´å¹¶æ»šåŠ¨ï¼›æ³¨æ„ padding-bottom ä¸ºæ§ä»¶é«˜åº¦ï¼Œé˜²æ­¢è¢«å›ºå®šæ§ä»¶é®æŒ¡ */
    .chat-box{
      flex:1 1 auto;
      min-height:0; /* å…³é”®ï¼šåœ¨ flex ä¸­å…è®¸æº¢å‡ºæ»šåŠ¨ */
      margin:8px 12px;
      border-radius:10px;
      background:var(--chat-bg);
      border:1px solid rgba(230,240,250,1);
      padding:12px;
      padding-bottom: calc(var(--controls-height) + var(--safe-bottom) + 12px);
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      scroll-behavior:smooth;
    }

    .messages{display:flex; flex-direction:column; gap:10px;}

    .message{max-width:86%; padding:10px 12px; border-radius:12px; line-height:1.45; word-break:break-word; box-shadow:0 2px 6px rgba(20,40,60,0.03); opacity:0; transform:translateY(6px); animation:fadeUp .12s forwards;}
    @keyframes fadeUp{to{opacity:1; transform:translateY(0);} }

    .message.user{background:linear-gradient(90deg,#eef6ff,#e9f2ff); color:#071129; margin-left:auto; text-align:right; border-bottom-right-radius:6px;}
    .message.assistant{background:#fff; color:#071129; border:1px solid #eef6ff; border-bottom-left-radius:6px;}

    .meta{font-size:0.72rem; color:var(--muted); margin-bottom:6px;}

    /* åº•éƒ¨å›ºå®šçš„å‘é€æ§ä»¶ï¼šå±…ä¸­æ˜¾ç¤ºäºè§†å£åº•ç«¯ï¼Œé€‚é…å®‰å…¨åŒº */
    .controls {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(var(--safe-bottom));
      width: calc(100% - 24px);
      max-width: 920px;
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px;
      height: calc(var(--controls-height) - 8px);
      background: rgba(255,255,255,0.98);
      border-top-left-radius:12px;
      border-top-right-radius:12px;
      box-shadow: 0 -6px 18px rgba(20,40,60,0.04);
      border: 1px solid rgba(230,240,250,0.8);
      z-index: 60;
    }

    .input-wrap{flex:1; display:flex; align-items:center;}
    textarea#userInput{
      width:100%;
      height:48px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #e6eef8;
      resize:none;
      font-size:0.95rem;
      background:white;
    }
    textarea#userInput:focus{outline:none; box-shadow:0 6px 18px rgba(58,103,184,0.06); border-color:#8aa8df;}

    #sendBtn{background:linear-gradient(90deg,var(--primary-1),var(--primary-2)); color:white; padding:10px 14px; border-radius:10px; border:none; font-weight:700; cursor:pointer; min-width:76px;}
    #sendBtn:disabled{opacity:0.6; cursor:not-allowed;}

    /* å½“é”®ç›˜å¼¹èµ·ï¼Œfixed å…ƒç´ åœ¨è®¸å¤šæ‰‹æœºæµè§ˆå™¨ä¼šè‡ªåŠ¨éšè§†å£ä¸Šç§»ï¼›åŒæ—¶ç›‘å¬ resize ä»¥ä¿æŒæ»šåŠ¨åº•éƒ¨ */
    @media (max-width:700px){
      .chat-box{margin:6px 10px; padding-bottom: calc(var(--controls-height) + var(--safe-bottom) + 8px);}
      .controls{width: calc(100% - 20px); padding:8px; height:64px;}
      textarea#userInput{height:44px;}
    }

    /* å»æ‰é»˜è®¤æ»šåŠ¨æ¡å½±å“è§†è§‰ï¼ˆå¯é€‰ï¼‰ */
    ::-webkit-scrollbar{width:8px;height:8px;}
    ::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.08); border-radius:8px;}
  </style>
</head>
<body>
  <div id="app" class="app">
    <div class="viewport">
      <header>
        <div class="logo"><i class="fas fa-brain"></i> Psychç»Ÿè®¡è‡ªä¹ å®¤ â€” AI å¿ƒç†ç–å¯¼</div>
      </header>

      <div class="chat-wrapper">
        <div id="chatBox" class="chat-box" role="log" aria-live="polite" tabindex="0">
          <div id="messages" class="messages"></div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨æ§ä»¶å›ºå®šåœ¨è§†å£åº•ç«¯ -->
    <div class="controls" role="region" aria-label="å‘é€åŒºåŸŸ">
      <div class="input-wrap">
        <textarea id="userInput" placeholder="è¯·ç®€è¦æè¿°æœ€è¿‘è®©ä½ å›°æ‰°çš„ä¸€ä»¶äº‹" aria-label="æ¶ˆæ¯è¾“å…¥"></textarea>
      </div>
      <button id="sendBtn">å‘é€</button>
    </div>
  </div>

  <script>
    (function(){
      // æ›¿æ¢ä¸ºä½ çš„åç«¯åœ°å€
      const API_URL = 'https://psych-chat-fbfnuvfetv.cn-hongkong.fcapp.run';

      /* ===============================
      * ğŸ”´ æ–°å¢ï¼šä¼šè¯ sessionIdï¼ˆæœ¬åœ°æŒä¹…ï¼‰
      * =============================== */
      let sessionId = localStorage.getItem('psych_session_id');
      if (!sessionId) {
          sessionId = crypto.randomUUID();
          localStorage.setItem('psych_session_id', sessionId);
      }

      const messagesEl = document.getElementById('messages');
      const chatBox = document.getElementById('chatBox');
      const sendBtn = document.getElementById('sendBtn');
      const userInput = document.getElementById('userInput');

      // åˆ›å»ºæ¶ˆæ¯èŠ‚ç‚¹
      function createMessageNode(role, text){
        const wrapper = document.createElement('div');
        wrapper.className = 'message ' + (role === 'user' ? 'user' : 'assistant');
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = (role === 'user' ? 'ä½ ' : 'AI å¼•å¯¼') + ' Â· ' + new Date().toLocaleTimeString();
        const content = document.createElement('div');
        // ç®€å•æ¢è¡Œå¤„ç†ï¼ˆè‹¥åç«¯ä¸å¯ä¿¡è¯·å…ˆåšæ–‡æœ¬è½¬ä¹‰ï¼‰
        content.innerHTML = text.replace(/\n/g, '<br>');
        wrapper.appendChild(meta);
        wrapper.appendChild(content);
        return wrapper;
      }

      // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆä¿ç•™ä¸€äº›å¯è§ç¼“å†²ï¼‰
      function scrollToBottom(){
        // scrollTop to full height
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function appendMessage(role, text){
        const node = createMessageNode(role, text);
        messagesEl.appendChild(node);
        scrollToBottom();
      }

      function setLoading(v){
        sendBtn.disabled = v;
        userInput.disabled = v;
        sendBtn.textContent = v ? 'æ€è€ƒä¸­...' : 'å‘é€';
      }

      function fetchWithTimeout(url, options = {}, timeout = 30000){
        return new Promise((resolve,reject) => {
          const t = setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), timeout);
          fetch(url, options).then(res => { clearTimeout(t); resolve(res); }).catch(err => { clearTimeout(t); reject(err); });
        });
      }

      async function sendMessage(text){
        if(!text || !text.trim()) return;
        appendMessage('user', text);
        userInput.value = '';
        setLoading(true);

        // æ·»åŠ  typing å ä½
        const typingNode = createMessageNode('assistant', 'æ€è€ƒä¸­â€¦');
        typingNode.querySelector('.meta').textContent = 'AI å¼•å¯¼ Â· ' + new Date().toLocaleTimeString();
        typingNode.querySelector('div:nth-child(2)').classList.add('typing');
        messagesEl.appendChild(typingNode);
        scrollToBottom();

        try{
          if(!API_URL || API_URL === 'REPLACE_WITH_YOUR_CLOUD_FUNCTION_URL'){
            typingNode.remove();
            appendMessage('assistant', 'æŠ±æ­‰ï¼ŒæœåŠ¡æœªé…ç½®ï¼šåç«¯åœ°å€(API_URL)æœªè®¾ç½®ã€‚');
            setLoading(false);
            return;
          }

          const resp = await fetchWithTimeout(API_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                  sessionId: sessionId,
                  message: text
                  })
          }, 30000);

          typingNode.remove();

          if(!resp.ok){
            let errText = '';
            try { const j = await resp.json(); errText = j.error || JSON.stringify(j); } catch(e){ errText = await resp.text(); }
            appendMessage('assistant', 'æŠ±æ­‰ï¼ŒæœåŠ¡æš‚ä¸å¯ç”¨ï¼š' + (errText || (resp.status + ' ' + resp.statusText)));
            setLoading(false);
            return;
          }

          const data = await resp.json();
          const assistantText = data.reply || '[æœªè¿”å›å†…å®¹]';
          appendMessage('assistant', assistantText);
        } catch(e){
          console.error(e);
          typingNode.remove();
          appendMessage('assistant', 'å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ï¼š' + (e.message || e));
        } finally {
          setLoading(false);
        }
      }

      // äº‹ä»¶ï¼šEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
      sendBtn.addEventListener('click', () => { sendMessage(userInput.value); });

      userInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          sendMessage(userInput.value);
        }
      });

      // å½“è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼ˆå°¤å…¶æ˜¯ç§»åŠ¨ç«¯å¼¹é”®ç›˜ï¼‰ï¼ŒæŠŠæ¶ˆæ¯åŒºæ»šåˆ°åº•
      userInput.addEventListener('focus', () => { setTimeout(scrollToBottom, 300); });

      // ç›‘å¬è§†å£å˜åŒ–ï¼ˆé”®ç›˜å¼¹èµ·/æ”¶èµ·ï¼‰ï¼Œä¿è¯æ»šåŠ¨åˆ°åº•éƒ¨
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => { scrollToBottom(); }, 120);
      });

      // åˆå§‹æç¤ºï¼ˆå¯åˆ é™¤ï¼‰
      appendMessage('assistant', 'ä½ å¥½ï¼æˆ‘æ˜¯è®¤çŸ¥é‡æ„è¾…åŠ©å¼•å¯¼ã€‚è‹¥ä½ å‡†å¤‡å¥½ï¼Œè¯·æè¿°æœ€è¿‘è®©ä½ æ„Ÿåˆ°å›°æ‰°çš„ä¸€ä»¶äº‹ã€‚');

      // é¦–æ¬¡æ»šåŠ¨å¹¶èšç„¦è¾“å…¥æ¡†ä»¥ä¾¿æ‰‹æœºç”¨æˆ·ç«‹å³è¾“å…¥
      setTimeout(() => { scrollToBottom(); userInput.focus(); }, 300);
    })();
  </script>
</body>
</html>
