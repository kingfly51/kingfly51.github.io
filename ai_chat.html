<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI 心理疏导 - Psych统计自习室</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* 精简且针对聊天组件的视觉优化（兼顾移动端） */
    * { box-sizing: border-box; margin:0; padding:0; font-family: 'Helvetica Neue', Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif; }
    html,body { height:100%; }
    body { background: #f3f6fb; color: #1f2937; line-height:1.6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .container { max-width: 920px; margin: 18px auto; padding: 16px; display:flex; flex-direction:column; gap:14px; min-height:calc(100vh - 36px); }

    header { background: linear-gradient(135deg, #4a6fa5 0%, #2c4c75 100%); padding: 14px 16px; color:#fff; border-radius:10px; box-shadow: 0 6px 18px rgba(44,76,117,0.12); }
    .logo { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px; }
    .logo i { font-size:22px; }

    .chat-section {
      background: white;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(20,40,60,0.06);
      padding: 12px;
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:420px;
      overflow:hidden;
    }

    .section-head { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:6px 4px 12px 4px; }
    .section-title { color:#123458; font-size:1.1rem; display:flex; align-items:center; gap:10px; }
    .section-desc { color:#566777; font-size:0.9rem; margin-top:6px; }

    .chat-area { display:flex; flex-direction:column; flex:1; gap:12px; min-height:200px; }
    .chat-box {
      background: #f7fbff;
      border-radius: 12px;
      padding: 14px;
      flex:1;
      overflow-y: auto;
      border: 1px solid #e6f0fa;
      scroll-behavior:smooth;
      transition: all .18s ease;
    }

    .message { max-width:84%; padding: 12px 14px; border-radius: 14px; margin-bottom:12px; line-height:1.45; word-break:break-word; box-shadow: 0 2px 6px rgba(20,40,60,0.04); opacity:0; transform: translateY(6px); animation: fadeUp .18s forwards; }
    @keyframes fadeUp { to { opacity:1; transform: translateY(0); } }

    .message.user { background: linear-gradient(90deg,#e7f1ff,#e2f0ff); color:#071129; margin-left:auto; text-align:right; border-bottom-right-radius:6px; border-bottom-left-radius:14px; }
    .message.assistant { background: white; color:#071129; border:1px solid #eef6ff; border-bottom-left-radius:6px; border-bottom-right-radius:14px; }

    .meta { font-size:0.78rem; color:#7b8a9a; margin-bottom:6px; }

    .controls {
      display:flex;
      gap:10px;
      align-items:flex-end;
      padding-top:6px;
      border-top:1px solid rgba(15,23,42,0.03);
    }

    .input-wrap { display:flex; gap:8px; align-items:flex-end; flex:1; }
    textarea#userInput { flex:1; min-height:64px; max-height:220px; padding:12px 14px; border-radius:10px; border:1px solid #e6eef8; resize:vertical; background:white; font-size:0.95rem; box-shadow: inset 0 1px 0 rgba(16,24,40,0.02); }
    textarea#userInput:focus { outline: none; border-color:#8aa8df; box-shadow:0 4px 18px rgba(58,103,184,0.08); }

    button.btn { background: linear-gradient(90deg,#3f6ea8,#2b4e78); color:white; padding:12px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; font-size:0.95rem; min-width:86px; }
    button.btn:disabled { opacity:0.6; cursor:not-allowed; }
    .btn-outline { background:transparent; border:1px solid #cfe1fb; color:#2c4c75; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; }

    .small { font-size:0.88rem; color:#6b7b8d; }
    .typing { display:inline-block; width:56px; height:18px; background:linear-gradient(90deg,#e8f1ff,#ffffff); border-radius:10px; padding:4px 6px; font-size:0.82rem; color:#617a9a; }

    .footer-note { margin-top:10px; font-size:0.86rem; color:#6b7b8d; }

    @media (max-width:700px) {
      .container { padding:12px; margin:12px; }
      header .logo { font-size:16px; }
      button.btn { min-width:72px; padding:10px 12px; }
      textarea#userInput { min-height:56px; }
      .chat-box { padding:12px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container" style="padding:0;">
      <div class="logo"><i class="fas fa-brain"></i> Psych统计自习室 — AI 心理疏导</div>
    </div>
  </header>

  <main class="container" style="padding-top:4px;">
    <section class="chat-section" aria-labelledby="ai-chat-title">
      <div class="section-head">
        <div>
          <div id="ai-chat-title" class="section-title"><i class="fas fa-comment-medical"></i> AI 心理疏导（认知重构辅助）</div>
          <div class="section-desc">AI 将按“认知重构五步法”逐步引导。请注意：若有严重困扰请寻求专业帮助。</div>
        </div>
      </div>

      <div class="chat-area" role="region" aria-label="聊天区">
        <div class="chat-box" id="chatBox" role="log" aria-live="polite" tabindex="0"></div>

        <div class="controls" role="region" aria-label="发送区域">
          <div class="input-wrap">
            <textarea id="userInput" placeholder="你最近有没有遇到让你困扰的事情？可以简单描述（按 Enter 发送，Shift+Enter 换行）" aria-label="消息输入框"></textarea>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <button id="sendBtn" class="btn">发送</button>
          </div>
        </div>

        <div class="footer-note">
          <strong>免责声明：</strong> 本系统提供基于模型的认知重构引导，不替代临床咨询。如情绪严重影响日常或存在自伤/自杀风险，请立即联系专业机构或就近急诊。
        </div>
      </div>
    </section>
  </main>

  <script>
    (function() {
      /**
       * 请替换为你的云函数/网关完整 URL（以 https:// 开头）
       */
      const API_URL = 'https://psych-chat-fbfnuvfetv.cn-hongkong.fcapp.run'; // <-- 替换为你的触发器 URL

      const chatBox = document.getElementById('chatBox');
      const sendBtn = document.getElementById('sendBtn');
      const userInput = document.getElementById('userInput');

      let messages = []; // {role, text, ts}

      function appendMessage(role, text) {
        const wrapper = document.createElement('div');
        wrapper.className = 'message ' + (role === 'user' ? 'user' : 'assistant');

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = (role === 'user' ? '你' : 'AI 引导') + ' · ' + new Date().toLocaleString();

        const content = document.createElement('div');
        content.innerHTML = text.replace(/\n/g,'<br>');

        wrapper.appendChild(meta);
        wrapper.appendChild(content);
        chatBox.appendChild(wrapper);

        chatBox.scrollTop = chatBox.scrollHeight;
        chatBox.focus({preventScroll:true});
      }

      function setLoading(loading) {
        sendBtn.disabled = loading;
        userInput.disabled = loading;
        if (loading) sendBtn.textContent = '思考中...';
        else sendBtn.textContent = '发送';
      }

      // fetch with timeout
      function fetchWithTimeout(url, options = {}, timeout = 30000) {
        return new Promise((resolve, reject) => {
          const timer = setTimeout(() => {
            reject(new Error('请求超时'));
          }, timeout);

          fetch(url, options).then((res) => {
            clearTimeout(timer);
            resolve(res);
          }).catch((err) => {
            clearTimeout(timer);
            reject(err);
          });
        });
      }

      async function sendMessage(text) {
        if (!text || !text.trim()) return;

        appendMessage('user', text);
        messages.push({role:'user', text, ts: Date.now()});
        userInput.value = '';
        setLoading(true);

        try {
          if (!API_URL || API_URL === 'REPLACE_WITH_YOUR_CLOUD_FUNCTION_URL') {
            appendMessage('assistant', '抱歉，服务未配置：后端地址(API_URL)未设置。请将页面中的 API_URL 替换为你的云函数触发器 URL。');
            setLoading(false);
            return;
          }

          // typing indicator
          const typingNode = document.createElement('div');
          typingNode.className = 'message assistant';
          typingNode.innerHTML = '<div class="meta">AI 引导 · ' + new Date().toLocaleTimeString() + '</div><div class="typing">思考中…</div>';
          chatBox.appendChild(typingNode);
          chatBox.scrollTop = chatBox.scrollHeight;

          const resp = await fetchWithTimeout(API_URL, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ message: text })
          }, 30000);

          typingNode.remove();

          if (!resp.ok) {
            let errText = '';
            try {
              const j = await resp.json();
              errText = j.error || JSON.stringify(j);
            } catch (e) {
              errText = await resp.text();
            }
            appendMessage('assistant', '抱歉，服务暂不可用：' + (errText || (resp.status + ' ' + resp.statusText)));
            setLoading(false);
            return;
          }

          const data = await resp.json();
          const assistantText = data.reply || '[未返回内容]';
          appendMessage('assistant', assistantText);
          messages.push({role:'assistant', text: assistantText, ts: Date.now()});
        } catch (e) {
          console.error(e);
          appendMessage('assistant', '发生错误，请稍后再试：' + (e.message || e));
        } finally {
          setLoading(false);
        }
      }

      // Enter 发送，Shift+Enter 换行
      sendBtn.addEventListener('click', () => sendMessage(userInput.value));
      userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage(userInput.value);
        }
      });

      // 初始友好提示
      appendMessage('assistant', '你好！我是认知重构辅助引导。若你准备好，请描述最近让你感到困扰的一件事。');
      setTimeout(() => { userInput.focus(); }, 300);
    })();
  </script>
</body>
</html>
